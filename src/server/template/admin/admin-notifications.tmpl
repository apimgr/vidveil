{{define "content"}}
<div class="card">
    <h2>Your Notifications</h2>
    <p>View and manage your personal notifications. These are notifications directed to you as an admin.</p>
    <div class="notification-actions">
        <button class="btn btn-secondary" onclick="markAllRead()">Mark All Read</button>
        <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
    </div>
</div>

<div class="card" id="notifications-list">
    <div class="empty-state">
        <p>No notifications</p>
        <p class="text-muted">You're all caught up!</p>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
async function loadNotifications() {
    try {
        const resp = await fetch(window.API_BASE + '/notifications/personal');
        const data = await resp.json();
        if (data.success && data.data && data.data.length > 0) {
            renderNotifications(data.data);
        }
    } catch (e) {
        console.error('Failed to load notifications:', e);
    }
}

function renderNotifications(notifications) {
    const container = document.getElementById('notifications-list');
    if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No notifications</p><p class="text-muted">You\'re all caught up!</p></div>';
        return;
    }

    let html = '';
    notifications.forEach(n => {
        const readClass = n.read ? 'notification-read' : 'notification-unread';
        html += `<div class="notification-item ${readClass}" data-id="${n.id}">
            <div class="notification-content">
                <div class="notification-title">${escapeHtml(n.title)}</div>
                <div class="notification-message">${escapeHtml(n.message)}</div>
                <div class="notification-time">${formatTime(n.created_at)}</div>
            </div>
            <div class="notification-actions">
                <button class="btn btn-small" onclick="dismissNotification('${n.id}')">Dismiss</button>
            </div>
        </div>`;
    });
    container.innerHTML = html;
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleString();
}

async function markAllRead() {
    try {
        const resp = await fetch(window.API_BASE + '/notifications/personal/read-all', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            showSuccess('All notifications marked as read');
            loadNotifications();
        }
    } catch (e) {
        showError('Failed to mark notifications as read');
    }
}

async function clearAll() {
    if (!confirm('Clear all notifications?')) return;
    try {
        const resp = await fetch(window.API_BASE + '/notifications/personal/clear', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            showSuccess('All notifications cleared');
            loadNotifications();
        }
    } catch (e) {
        showError('Failed to clear notifications');
    }
}

async function dismissNotification(id) {
    try {
        const resp = await fetch(window.API_BASE + '/notifications/personal/' + id, { method: 'DELETE' });
        const data = await resp.json();
        if (data.success) {
            loadNotifications();
        }
    } catch (e) {
        showError('Failed to dismiss notification');
    }
}

loadNotifications();
</script>
{{end}}
