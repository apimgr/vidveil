{{define "content"}}
<div class="card">
    <h2>Maintenance Mode</h2>
    <form id="maintenance-form" onsubmit="saveMaintenanceMode(event)">
        <div class="form-group">
            <label class="toggle-label">
                <input type="checkbox" id="maintenance-enabled">
                <span>Enable Maintenance Mode</span>
            </label>
            <p class="help-text">When enabled, visitors see a maintenance page instead of the site</p>
        </div>
        <div class="form-group">
            <label for="maintenance-message">Maintenance Message</label>
            <textarea id="maintenance-message" rows="3" placeholder="We're performing scheduled maintenance. Please check back soon."></textarea>
        </div>
        <div class="form-group">
            <label for="maintenance-bypass">Bypass IPs</label>
            <textarea id="maintenance-bypass" rows="3" placeholder="One IP per line&#10;These IPs can access the site during maintenance"></textarea>
        </div>
        <div class="button-group">
            <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
    </form>
</div>

<div class="card">
    <h2>Scheduled Maintenance</h2>
    <form id="schedule-form" onsubmit="scheduleMaintenance(event)">
        <div class="form-group">
            <label for="schedule-start">Start Time</label>
            <input type="datetime-local" id="schedule-start">
        </div>
        <div class="form-group">
            <label for="schedule-end">End Time</label>
            <input type="datetime-local" id="schedule-end">
        </div>
        <div class="form-group">
            <label class="toggle-label">
                <input type="checkbox" id="schedule-notify">
                <span>Show countdown to users</span>
            </label>
        </div>
        <div class="button-group">
            <button type="submit" class="btn btn-secondary">Schedule Maintenance</button>
        </div>
    </form>
</div>

<div class="card">
    <h2>Cache Management</h2>
    <table class="info-table">
        <tr><td>Template Cache</td><td>Active</td></tr>
        <tr><td>Search Cache</td><td>Active</td></tr>
        <tr><td>Static Assets</td><td>Active</td></tr>
    </table>
    <div class="button-group">
        <button onclick="clearCache('templates')" class="btn btn-secondary">Clear Template Cache</button>
        <button onclick="clearCache('search')" class="btn btn-secondary">Clear Search Cache</button>
        <button onclick="clearCache('all')" class="btn btn-warning">Clear All Caches</button>
    </div>
</div>

<div class="card">
    <h2>Database Maintenance</h2>
    <div class="button-group">
        <button onclick="optimizeDatabase()" class="btn btn-secondary">Optimize Database</button>
        <button onclick="vacuumDatabase()" class="btn btn-secondary">Vacuum Database</button>
    </div>
    <p class="help-text">These operations may take a few moments to complete</p>
</div>
{{end}}

{{define "scripts"}}
<script>
// Save maintenance mode settings per AI.md PART 17
async function saveMaintenanceMode(e) {
    e.preventDefault();
    try {
        const bypassIPs = document.getElementById('maintenance-bypass').value
            .split('\n').map(ip => ip.trim()).filter(ip => ip);
        const resp = await fetch(window.API_BASE + '/server/settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server: {
                    maintenance: {
                        enabled: document.getElementById('maintenance-enabled').checked,
                        message: document.getElementById('maintenance-message').value,
                        bypass_ips: bypassIPs
                    }
                }
            })
        });
        const data = await resp.json();
        if (data.ok) { showSuccess('Maintenance settings saved!'); }
        else { showError('Error: ' + data.error); }
    } catch (err) { showError('Error: ' + err.message); }
}

// Schedule maintenance window per AI.md PART 17
async function scheduleMaintenance(e) {
    e.preventDefault();
    try {
        const resp = await fetch(window.API_BASE + '/server/settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server: {
                    maintenance: {
                        scheduled: {
                            start: document.getElementById('schedule-start').value,
                            end: document.getElementById('schedule-end').value,
                            show_countdown: document.getElementById('schedule-notify').checked
                        }
                    }
                }
            })
        });
        const data = await resp.json();
        if (data.ok) { showSuccess('Maintenance scheduled!'); }
        else { showError('Error: ' + data.error); }
    } catch (err) { showError('Error: ' + err.message); }
}

// Clear cache per AI.md PART 9
async function clearCache(type) {
    try {
        const resp = await fetch(window.API_BASE + '/cache/clear?type=' + encodeURIComponent(type), {
            method: 'POST'
        });
        const data = await resp.json();
        if (data.ok) {
            showSuccess(data.message || 'Cache cleared: ' + type);
        } else {
            showError(data.error || 'Failed to clear cache');
        }
    } catch (e) {
        showError('Error: ' + e.message);
    }
}

// Database optimization - runs ANALYZE per AI.md PART 10
async function optimizeDatabase() {
    try {
        const resp = await fetch(window.API_BASE + '/database/analyze', {
            method: 'POST'
        });
        const data = await resp.json();
        if (data.ok) {
            showSuccess('Database optimization completed');
        } else {
            showError(data.error || 'Failed to optimize database');
        }
    } catch (e) {
        showError('Error: ' + e.message);
    }
}

// Database vacuum - runs VACUUM per AI.md PART 10
async function vacuumDatabase() {
    try {
        const resp = await fetch(window.API_BASE + '/database/vacuum', {
            method: 'POST'
        });
        const data = await resp.json();
        if (data.ok) {
            showSuccess('Database vacuum completed');
        } else {
            showError(data.error || 'Failed to vacuum database');
        }
    } catch (e) {
        showError('Error: ' + e.message);
    }
}
</script>
{{end}}
