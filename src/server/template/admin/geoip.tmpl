{{define "content"}}
<div class="card">
    <h2>GeoIP Database</h2>
    <table class="info-table">
        <tr><td>Status</td><td><span class="badge badge-success">Active</span></td></tr>
        <tr><td>Database</td><td>MaxMind GeoLite2</td></tr>
        <tr><td>Last Updated</td><td>Not available</td></tr>
        <tr><td>Total Records</td><td>-</td></tr>
    </table>
    <div class="button-group">
        <button onclick="updateGeoIP()" class="btn btn-secondary">Update Database</button>
    </div>
</div>

<div class="card">
    <h2>GeoIP Settings</h2>
    <form id="geoip-form" onsubmit="saveGeoIP(event)">
        <div class="form-group">
            <label class="toggle-label">
                <input type="checkbox" id="geoip-enabled">
                <span>Enable GeoIP Filtering</span>
            </label>
            <p class="help-text">Block or allow access based on geographic location</p>
        </div>
        <div class="form-group">
            <label for="geoip-mode">Filtering Mode</label>
            <select id="geoip-mode">
                <option value="allowlist">Allowlist (only allow listed countries)</option>
                <option value="blocklist">Blocklist (block listed countries)</option>
            </select>
        </div>
        <div class="button-group">
            <button type="submit" class="btn btn-primary">Save Settings</button>
        </div>
    </form>
</div>

<div class="card">
    <h2>Country List</h2>
    <form id="countries-form" onsubmit="saveCountries(event)">
        <div class="form-group">
            <label for="countries">Countries</label>
            <textarea id="countries" rows="6" placeholder="One country code per line&#10;Example:&#10;US&#10;CA&#10;GB"></textarea>
            <p class="help-text">Use ISO 3166-1 alpha-2 country codes</p>
        </div>
        <div class="button-group">
            <button type="submit" class="btn btn-primary">Save Countries</button>
        </div>
    </form>
</div>

<div class="card">
    <h2>Recent GeoIP Blocks</h2>
    <table class="data-table">
        <thead>
            <tr><th>IP Address</th><th>Country</th><th>Time</th></tr>
        </thead>
        <tbody>
            <tr><td colspan="3" class="text-center">No recent blocks</td></tr>
        </tbody>
    </table>
</div>
{{end}}

{{define "scripts"}}
<script>
// GeoIP database update - triggers scheduler task per AI.md PART 19
async function updateGeoIP() {
    try {
        const resp = await fetch(window.API_BASE + '/scheduler/geoip.update/run', {
            method: 'POST'
        });
        const data = await resp.json();
        if (data.success) {
            showSuccess('GeoIP database update triggered');
        } else {
            showError(data.error || 'Failed to trigger update');
        }
    } catch (e) {
        showError('Error: ' + e.message);
    }
}
// Save GeoIP settings per AI.md PART 20
async function saveGeoIP(e) {
    e.preventDefault();
    try {
        const resp = await fetch(window.API_BASE + '/server/settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server: {
                    geoip: {
                        enabled: document.getElementById('geoip-enabled').checked,
                        mode: document.getElementById('geoip-mode').value
                    }
                }
            })
        });
        const data = await resp.json();
        if (data.ok) { showSuccess('GeoIP settings saved!'); }
        else { showError('Error: ' + data.error); }
    } catch (err) { showError('Error: ' + err.message); }
}

// Save country list per AI.md PART 20
async function saveCountries(e) {
    e.preventDefault();
    try {
        const countries = document.getElementById('countries').value
            .split('\n').map(c => c.trim().toUpperCase()).filter(c => c && c.length === 2);
        const resp = await fetch(window.API_BASE + '/server/settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server: {
                    geoip: {
                        deny_countries: countries
                    }
                }
            })
        });
        const data = await resp.json();
        if (data.ok) { showSuccess('Country list saved!'); }
        else { showError('Error: ' + data.error); }
    } catch (err) { showError('Error: ' + err.message); }
}
</script>
{{end}}
