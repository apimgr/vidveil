{{define "title"}}Logs{{end}}

{{define "content"}}
<div class="admin-section">
    <h1>Log Viewer</h1>
    
    {{if .Error}}
    <div class="alert alert-error">
        <strong>Error:</strong> {{.Error}}
    </div>
    {{end}}
    
    <div class="card">
        <div class="log-controls">
            <form method="get" action="/admin/logs" class="log-filter-form">
                <label for="type">Log Type:</label>
                <select id="type" name="type" onchange="this.form.submit()">
                    <option value="access" {{if eq .LogType "access"}}selected{{end}}>Access</option>
                    <option value="error" {{if eq .LogType "error"}}selected{{end}}>Error</option>
                    <option value="audit" {{if eq .LogType "audit"}}selected{{end}}>Audit</option>
                    <option value="security" {{if eq .LogType "security"}}selected{{end}}>Security</option>
                    <option value="debug" {{if eq .LogType "debug"}}selected{{end}}>Debug</option>
                </select>
                
                <label for="limit">Show:</label>
                <select id="limit" name="limit" onchange="this.form.submit()">
                    <option value="100" {{if eq .Limit 100}}selected{{end}}>Last 100</option>
                    <option value="250" {{if eq .Limit 250}}selected{{end}}>Last 250</option>
                    <option value="500" {{if eq .Limit 500}}selected{{end}}>Last 500</option>
                    <option value="1000" {{if eq .Limit 1000}}selected{{end}}>Last 1000</option>
                </select>
                
                <label for="search">Search:</label>
                <input type="text" id="search" name="search" value="{{.Search}}" placeholder="Filter logs...">
                
                <button type="submit">Refresh</button>
                <a href="/admin/logs?type={{.LogType}}&limit={{.Limit}}" class="button">Clear Search</a>
            </form>
        </div>
        
        {{if .Entries}}
        <div class="log-viewer">
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Level</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Entries}}
                    <tr class="log-entry log-level-{{.Level}}">
                        <td class="log-timestamp">{{.Timestamp}}</td>
                        <td class="log-level">{{.Level}}</td>
                        <td class="log-message">{{.Message}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        
        <div class="log-info">
            Showing {{len .Entries}} entries (most recent first)
        </div>
        {{else}}
        <div class="alert alert-info">
            <p>No log entries found.</p>
            {{if .Search}}
            <p>Try clearing your search filter.</p>
            {{end}}
        </div>
        {{end}}
    </div>
    
    <style>
    .log-controls {
        padding: 1rem;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
    }
    
    .theme-dark .log-controls {
        background: #2a2a2a;
        border-bottom-color: #444;
    }
    
    .log-filter-form {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .log-filter-form label {
        font-weight: 600;
    }
    
    .log-filter-form select,
    .log-filter-form input[type="text"] {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .theme-dark .log-filter-form select,
    .theme-dark .log-filter-form input[type="text"] {
        background: #333;
        border-color: #555;
        color: #eee;
    }
    
    .log-filter-form input[type="text"] {
        min-width: 200px;
    }
    
    .log-filter-form button,
    .log-filter-form .button {
        padding: 0.5rem 1rem;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    
    .log-filter-form button:hover,
    .log-filter-form .button:hover {
        background: #0056b3;
    }
    
    .log-viewer {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .log-table {
        width: 100%;
        border-collapse: collapse;
        font-family: monospace;
        font-size: 0.9rem;
    }
    
    .log-table th {
        background: #f5f5f5;
        padding: 0.5rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .theme-dark .log-table th {
        background: #2a2a2a;
        border-bottom-color: #444;
    }
    
    .log-table td {
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
    }
    
    .theme-dark .log-table td {
        border-bottom-color: #333;
    }
    
    .log-entry:hover {
        background: #f9f9f9;
    }
    
    .theme-dark .log-entry:hover {
        background: #333;
    }
    
    .log-timestamp {
        white-space: nowrap;
        color: #666;
    }
    
    .theme-dark .log-timestamp {
        color: #999;
    }
    
    .log-level {
        font-weight: 600;
        white-space: nowrap;
    }
    
    .log-level-DEBUG { color: #6c757d; }
    .log-level-INFO { color: #17a2b8; }
    .log-level-WARN { color: #ffc107; }
    .log-level-ERROR { color: #dc3545; }
    
    .log-message {
        word-break: break-all;
    }
    
    .log-info {
        padding: 1rem;
        text-align: center;
        color: #666;
        border-top: 1px solid #ddd;
    }
    
    .theme-dark .log-info {
        color: #999;
        border-top-color: #444;
    }
    
    .alert {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
    }
    
    .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .alert-info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }
    
    .theme-dark .alert-error {
        background: #3a1f1f;
        border-color: #5a2a2a;
        color: #f8d7da;
    }
    
    .theme-dark .alert-info {
        background: #1f2f3a;
        border-color: #2a4a5a;
        color: #d1ecf1;
    }
    </style>
</div>
{{end}}

{{define "scripts"}}
<script>
async function saveLogSettings(e) {
    e.preventDefault();
    try {
        const resp = await fetch('/api/v1/admin/config', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server: {
                    logging: {
                        level: document.getElementById('log-level').value,
                        format: document.getElementById('log-format').value,
                        output: document.getElementById('log-output').value,
                        path: document.getElementById('log-path').value,
                        max_size: parseInt(document.getElementById('log-max-size').value),
                        max_backups: parseInt(document.getElementById('log-max-backups').value)
                    }
                }
            })
        });
        const data = await resp.json();
        if (data.success) { showSuccess('Log settings saved!'); }
        else { showError('Error: ' + data.error); }
    } catch (e) { showError('Error: ' + e.message); }
}

async function saveAccessLogSettings(e) {
    e.preventDefault();
    try {
        const resp = await fetch('/api/v1/admin/config', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                server: {
                    logging: {
                        access: {
                            enabled: document.getElementById('access-enabled').checked,
                            anonymize: document.getElementById('access-anonymize').checked
                        }
                    }
                }
            })
        });
        const data = await resp.json();
        if (data.success) { showSuccess('Access log settings saved!'); }
        else { showError('Error: ' + data.error); }
    } catch (e) { showError('Error: ' + e.message); }
}

async function refreshLogs() {
    const filter = document.getElementById('log-filter').value;
    const lines = document.getElementById('log-lines').value;
    try {
        const resp = await fetch(`/api/v1/admin/logs?level=${filter}&lines=${lines}`);
        const data = await resp.json();
        if (data.success) {
            const output = document.getElementById('log-output');
            output.innerHTML = data.data.logs.map(line => {
                let cls = 'log-line-info';
                if (line.includes('ERROR') || line.includes('"level":"error"')) cls = 'log-line-error';
                else if (line.includes('WARN') || line.includes('"level":"warn"')) cls = 'log-line-warn';
                else if (line.includes('DEBUG') || line.includes('"level":"debug"')) cls = 'log-line-debug';
                return `<span class="${cls}">${escapeHtml(line)}</span>`;
            }).join('\n') || 'No logs found';
        } else { showError('Error: ' + data.error); }
    } catch (e) {
        document.getElementById('log-output').textContent = 'Error loading logs: ' + e.message;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function downloadLogs() {
    window.location.href = '/api/v1/admin/logs/download';
}

function clearLogs() {
    showConfirm('Are you sure you want to clear all logs?', async function() {
        try {
            const resp = await fetch('/api/v1/admin/logs/clear', { method: 'POST' });
            const data = await resp.json();
            if (data.success) { showSuccess('Logs cleared!'); refreshLogs(); }
            else { showError('Error: ' + data.error); }
        } catch (e) { showError('Error: ' + e.message); }
    });
}

// Load logs on page load
document.addEventListener('DOMContentLoaded', refreshLogs);
</script>
{{end}}
