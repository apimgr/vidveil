{{define "preferences"}}
<!DOCTYPE html>
<html lang="en" class="theme-{{.Theme}}">
<head>
    {{template "public/head" .}}
</head>
<body>
    {{template "public/header" .}}
    <main class="preferences">
        <h1>Preferences</h1>
        <form id="preferences-form">
            <section>
                <h2>Appearance</h2>
                <div class="form-group">
                    <label for="theme">Theme:</label>
                    <select id="theme" name="theme">
                        <option value="auto">Auto (System)</option>
                        <option value="dark">Dark (Dracula)</option>
                        <option value="light">Light</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="grid-density">Grid density:</label>
                    <select id="grid-density" name="gridDensity">
                        <option value="comfortable">Comfortable (larger cards)</option>
                        <option value="default" selected>Default</option>
                        <option value="compact">Compact (more cards)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="thumbnail-size">Thumbnail size:</label>
                    <select id="thumbnail-size" name="thumbnailSize">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
            </section>

            <section>
                <h2>Video Preview</h2>
                <div class="form-group">
                    <label for="autoplay-preview">
                        <input type="checkbox" id="autoplay-preview" name="autoplayPreview" checked>
                        Auto-play preview on hover (desktop)
                    </label>
                </div>
                <div class="form-group">
                    <label for="preview-delay">Preview delay:</label>
                    <select id="preview-delay" name="previewDelay">
                        <option value="0">Instant</option>
                        <option value="200" selected>Short (200ms)</option>
                        <option value="500">Medium (500ms)</option>
                        <option value="1000">Long (1s)</option>
                    </select>
                </div>
            </section>

            <section>
                <h2>Search Settings</h2>
                <div class="form-group">
                    <label for="results-per-page">Results per page:</label>
                    <select id="results-per-page" name="resultsPerPage">
                        <option value="0" selected>Infinite scroll</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="open-new-tab">
                        <input type="checkbox" id="open-new-tab" name="openNewTab" checked>
                        Open links in new tab
                    </label>
                </div>
            </section>

            <section>
                <h2>Default Filters</h2>
                <p class="section-description">These filters will be applied automatically to new searches:</p>
                <div class="form-group">
                    <label for="default-preview-only">
                        <input type="checkbox" id="default-preview-only" name="defaultPreviewOnly">
                        Show only videos with preview
                    </label>
                </div>
                <div class="form-group">
                    <label for="default-duration">Default duration filter:</label>
                    <select id="default-duration" name="defaultDuration">
                        <option value="" selected>Any</option>
                        <option value="short">Under 10 min</option>
                        <option value="medium">10-30 min</option>
                        <option value="long">Over 30 min</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="default-quality">Default quality filter:</label>
                    <select id="default-quality" name="defaultQuality">
                        <option value="" selected>Any</option>
                        <option value="4k">4K</option>
                        <option value="1080">1080p HD</option>
                        <option value="720">720p</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="default-sort">Default sort:</label>
                    <select id="default-sort" name="defaultSort">
                        <option value="" selected>Relevance</option>
                        <option value="duration-desc">Longest</option>
                        <option value="duration-asc">Shortest</option>
                        <option value="views">Most Viewed</option>
                        <option value="quality">Best Quality</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="min-duration">Minimum video duration:</label>
                    <select id="min-duration" name="minDuration">
                        <option value="0">No minimum</option>
                        <option value="60">1 minute</option>
                        <option value="180">3 minutes</option>
                        <option value="300">5 minutes</option>
                        <option value="600">10 minutes</option>
                        <option value="1200">20 minutes</option>
                        <option value="1800">30 minutes</option>
                    </select>
                </div>
            </section>

            <section>
                <h2>History</h2>
                <div class="form-group">
                    <label for="max-history">Maximum history items:</label>
                    <select id="max-history" name="maxHistory">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="0">Unlimited</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="auto-clear-history">Auto-clear history:</label>
                    <select id="auto-clear-history" name="autoClearHistory">
                        <option value="0" selected>Never</option>
                        <option value="1">After 1 day</option>
                        <option value="7">After 7 days</option>
                        <option value="30">After 30 days</option>
                    </select>
                </div>
                <div class="form-group form-group--buttons">
                    <button type="button" class="btn-secondary" onclick="exportHistory()">Export History</button>
                    <label class="btn-secondary btn-file">
                        Import History
                        <input type="file" accept=".json" onchange="importHistory(this.files[0])" hidden>
                    </label>
                    <button type="button" class="btn-danger" onclick="clearHistory()">Clear History</button>
                </div>
            </section>

            <section>
                <h2>Favorites</h2>
                <p class="section-description">You have <span id="favorites-count">0</span> favorites saved.</p>
                <div class="form-group form-group--buttons">
                    <button type="button" class="btn-secondary" onclick="exportFavorites()">Export Favorites</button>
                    <label class="btn-secondary btn-file">
                        Import Favorites
                        <input type="file" accept=".json" onchange="importFavorites(this.files[0])" hidden>
                    </label>
                    <button type="button" class="btn-danger" onclick="clearFavorites()">Clear Favorites</button>
                </div>
            </section>

            <section>
                <h2>Privacy</h2>
                <div class="form-group">
                    <label for="use-tor">
                        <input type="checkbox" id="use-tor" name="useTor">
                        Use Tor for all searches (requires Tor running)
                    </label>
                </div>
                <div class="form-group">
                    <label for="proxy-images">
                        <input type="checkbox" id="proxy-images" name="proxyImages">
                        Proxy thumbnails through server
                    </label>
                </div>
            </section>

            <section>
                <h2>Search Engines</h2>
                <p class="section-description">Select which engines to use for searches:</p>
                <div class="engine-tiers">
                    {{range .Engines}}
                    <label class="engine-toggle">
                        <input type="checkbox" name="engines" value="{{.Name}}" {{if .Enabled}}checked{{end}}>
                        {{.DisplayName}}
                    </label>
                    {{end}}
                </div>
                <div class="engine-actions">
                    <button type="button" onclick="selectAllEngines()">Select All</button>
                    <button type="button" onclick="selectNoneEngines()">Select None</button>
                </div>
            </section>

            <div class="form-actions">
                <button type="submit" class="primary">Save Preferences</button>
                <button type="button" onclick="resetPreferences()">Reset to Defaults</button>
            </div>
        </form>
    </main>
    {{template "public/footer" .}}
    <div id="toast" class="toast"></div>
    <script>
    (function() {
        const STORAGE_KEY = 'vidveil_prefs';
        const HISTORY_KEY = 'vidveil_history';
        const FAVORITES_KEY = 'vidveil_favorites';
        const form = document.getElementById('preferences-form');

        // Default preferences
        const defaults = {
            theme: 'auto',
            gridDensity: 'default',
            thumbnailSize: 'medium',
            autoplayPreview: true,
            previewDelay: '200',
            resultsPerPage: '0',  // Infinite scroll
            openNewTab: true,
            defaultPreviewOnly: false,
            defaultDuration: '',
            defaultQuality: '',
            defaultSort: '',
            minDuration: '0',
            maxHistory: '50',
            autoClearHistory: '0',
            useTor: false,
            proxyImages: false,
            engines: []
        };

        // Load preferences from localStorage on page load
        function loadPreferences() {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const prefs = { ...defaults, ...saved };

            // Appearance
            document.getElementById('theme').value = prefs.theme;
            document.documentElement.classList.remove('theme-dark', 'theme-light', 'theme-auto');
            document.documentElement.classList.add('theme-' + prefs.theme);
            document.getElementById('grid-density').value = prefs.gridDensity;
            document.getElementById('thumbnail-size').value = prefs.thumbnailSize;

            // Video Preview
            document.getElementById('autoplay-preview').checked = prefs.autoplayPreview;
            document.getElementById('preview-delay').value = prefs.previewDelay;

            // Search Settings
            document.getElementById('results-per-page').value = prefs.resultsPerPage;
            document.getElementById('open-new-tab').checked = prefs.openNewTab;

            // Default Filters
            document.getElementById('default-preview-only').checked = prefs.defaultPreviewOnly;
            document.getElementById('default-duration').value = prefs.defaultDuration;
            document.getElementById('default-quality').value = prefs.defaultQuality;
            document.getElementById('default-sort').value = prefs.defaultSort;
            document.getElementById('min-duration').value = prefs.minDuration;

            // History
            document.getElementById('max-history').value = prefs.maxHistory;
            document.getElementById('auto-clear-history').value = prefs.autoClearHistory;

            // Privacy
            document.getElementById('use-tor').checked = prefs.useTor;
            document.getElementById('proxy-images').checked = prefs.proxyImages;

            // Engines
            if (prefs.engines && prefs.engines.length > 0) {
                document.querySelectorAll('input[name="engines"]').forEach(cb => {
                    cb.checked = prefs.engines.includes(cb.value);
                });
            }

            // Update counts
            updateFavoritesCount();
        }

        // Save preferences to localStorage
        function savePreferences(e) {
            e.preventDefault();

            const engines = [];
            document.querySelectorAll('input[name="engines"]:checked').forEach(cb => {
                engines.push(cb.value);
            });

            const prefs = {
                theme: document.getElementById('theme').value,
                gridDensity: document.getElementById('grid-density').value,
                thumbnailSize: document.getElementById('thumbnail-size').value,
                autoplayPreview: document.getElementById('autoplay-preview').checked,
                previewDelay: document.getElementById('preview-delay').value,
                resultsPerPage: document.getElementById('results-per-page').value,
                openNewTab: document.getElementById('open-new-tab').checked,
                defaultPreviewOnly: document.getElementById('default-preview-only').checked,
                defaultDuration: document.getElementById('default-duration').value,
                defaultQuality: document.getElementById('default-quality').value,
                defaultSort: document.getElementById('default-sort').value,
                minDuration: document.getElementById('min-duration').value,
                maxHistory: document.getElementById('max-history').value,
                autoClearHistory: document.getElementById('auto-clear-history').value,
                useTor: document.getElementById('use-tor').checked,
                proxyImages: document.getElementById('proxy-images').checked,
                engines: engines
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));

            // Apply theme immediately
            document.documentElement.classList.remove('theme-dark', 'theme-light', 'theme-auto');
            document.documentElement.classList.add('theme-' + prefs.theme);

            showToast('Preferences saved!', 'success');

            setTimeout(() => { window.location.href = '/'; }, 1500);
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        function updateFavoritesCount() {
            const favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
            document.getElementById('favorites-count').textContent = favorites.length;
        }

        // Reset to defaults
        window.resetPreferences = function() {
            localStorage.removeItem(STORAGE_KEY);
            loadPreferences();
            showToast('Preferences reset to defaults', 'info');
        };

        // Engine selection
        window.selectAllEngines = function() {
            document.querySelectorAll('input[name="engines"]').forEach(cb => cb.checked = true);
        };
        window.selectNoneEngines = function() {
            document.querySelectorAll('input[name="engines"]').forEach(cb => cb.checked = false);
        };

        // History functions
        window.exportHistory = function() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            downloadJSON(history, 'vidveil-history.json');
            showToast('History exported', 'success');
        };

        window.importHistory = function(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        localStorage.setItem(HISTORY_KEY, JSON.stringify(data));
                        showToast('History imported (' + data.length + ' items)', 'success');
                    } else {
                        showToast('Invalid history file', 'error');
                    }
                } catch (err) {
                    showToast('Failed to parse file', 'error');
                }
            };
            reader.readAsText(file);
        };

        window.clearHistory = function() {
            if (confirm('Clear all search history?')) {
                localStorage.removeItem(HISTORY_KEY);
                showToast('History cleared', 'info');
            }
        };

        // Favorites functions
        window.exportFavorites = function() {
            const favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
            downloadJSON(favorites, 'vidveil-favorites.json');
            showToast('Favorites exported', 'success');
        };

        window.importFavorites = function(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        // Merge with existing favorites
                        const existing = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
                        const merged = [...data];
                        existing.forEach(fav => {
                            if (!merged.some(f => f.url === fav.url)) {
                                merged.push(fav);
                            }
                        });
                        localStorage.setItem(FAVORITES_KEY, JSON.stringify(merged));
                        updateFavoritesCount();
                        showToast('Favorites imported (' + data.length + ' items)', 'success');
                    } else {
                        showToast('Invalid favorites file', 'error');
                    }
                } catch (err) {
                    showToast('Failed to parse file', 'error');
                }
            };
            reader.readAsText(file);
        };

        window.clearFavorites = function() {
            if (confirm('Clear all favorites?')) {
                localStorage.removeItem(FAVORITES_KEY);
                updateFavoritesCount();
                showToast('Favorites cleared', 'info');
            }
        };

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Theme preview
        document.getElementById('theme').addEventListener('change', function() {
            document.documentElement.classList.remove('theme-dark', 'theme-light', 'theme-auto');
            document.documentElement.classList.add('theme-' + this.value);
        });

        form.addEventListener('submit', savePreferences);
        form.dataset.managed = 'true';  // Mark as handled by inline script
        loadPreferences();
    })();
    </script>
</body>
</html>
{{end}}
